-- PPU – Percentage of Paying Users – доля платящей аудитории относительно DAU


WITH RECURSIVE cte AS
(
    SELECT MIN(CAST(begin_dttm AS DATE)) AS dt FROM sessions
        UNION ALL
	SELECT dt + INTERVAL 1 DAY
      FROM cte
     WHERE dt + INTERVAL 1 DAY <= (SELECT MAX(CAST(begin_dttm AS DATE)) FROM sessions)
),
Dau As
(
SELECT cte.dt, COUNT(DISTINCT sessions.user_id) da_user
  FROM sessions RIGHT JOIN cte ON CAST(sessions.begin_dttm AS DATE) = cte.dt
 GROUP BY cte.dt
),
Pu AS
(
SELECT cte.dt, COUNT(DISTINCT payments.user_id) p_user
  FROM payments RIGHT JOIN cte ON CAST(payments.payment_dttm AS DATE) = cte.dt
 GROUP BY cte.dt
)
SELECT Pu.dt, (Pu.p_user/Dau.da_user) ppu
FROM Pu JOIN Dau ON Dau.dt = Pu.dt
ORDER BY Pu.dt;

+------------+--------+
| dt         | ppu    |
+------------+--------+
| 2018-08-02 | 0.0000 |
| 2018-08-03 | 0.0000 |
| 2018-08-04 | 0.0000 |
| 2018-08-05 | 0.0000 |
| 2018-08-06 | 0.0000 |
| 2018-08-07 | 0.5000 |
| 2018-08-08 | 0.0000 |
| 2018-08-09 | 0.0000 |
| 2018-08-10 | 0.2000 |
| 2018-08-11 | 0.4000 |
| 2018-08-12 | 0.1667 |
| 2018-08-13 | 0.1667 |
| 2018-08-14 | 0.2222 |
| 2018-08-15 | 0.6667 |
| 2018-08-16 | 0.0909 |
| 2018-08-17 | 0.2857 |
| 2018-08-18 | 0.0769 |
| 2018-08-19 | 0.1429 |
| 2018-08-20 | 0.1250 |
| 2018-08-21 | 0.1000 |
| 2018-08-22 | 0.0000 |
| 2018-08-23 | 0.1333 |
| 2018-08-24 | 0.2857 |
| 2018-08-25 | 0.1538 |
| 2018-08-26 | 0.0000 |
| 2018-08-27 | 0.3636 |
| 2018-08-28 | 0.2500 |
| 2018-08-29 | 0.0714 |
| 2018-08-30 | 0.2105 |
| 2018-08-31 | 0.1765 |
| 2018-09-01 | 0.2222 |
| 2018-09-02 | 0.1000 |
| 2018-09-03 | 0.0000 |
| 2018-09-04 | 0.1333 |
| 2018-09-05 | 0.0625 |
| 2018-09-06 | 0.1739 |
| 2018-09-07 | 0.0833 |
| 2018-09-08 | 0.2500 |
| 2018-09-09 | 0.1154 |
| 2018-09-10 | 0.1538 |
| 2018-09-11 | 0.2174 |
| 2018-09-12 | 0.1200 |
| 2018-09-13 | 0.1154 |
| 2018-09-14 | 0.1250 |
| 2018-09-15 | 0.2069 |
| 2018-09-16 | 0.2903 |
| 2018-09-17 | 0.1538 |
| 2018-09-18 | 0.0645 |
| 2018-09-19 | 0.2500 |
| 2018-09-20 | 0.1765 |
| 2018-09-21 | 0.2353 |
| 2018-09-22 | 0.1333 |
| 2018-09-23 | 0.1563 |
| 2018-09-24 | 0.2857 |
| 2018-09-25 | 0.2368 |
| 2018-09-26 | 0.3243 |
| 2018-09-27 | 0.3889 |
| 2018-09-28 | 0.3235 |
| 2018-09-29 | 0.3023 |
| 2018-09-30 | 0.2927 |
+------------+--------+
